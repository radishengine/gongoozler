<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
    <title>gongoozler</title>
    <script type='text/javascript' src='path-data-polyfill.js'></script>
    <script type='text/javascript' src='SubPath.js'></script>
    <style>
      /*
      #screen {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        outline: 1px solid silver;
      }
      */
      #screen-container {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
      }
      #screen-back {
        width: 100%;
        height: 100%;
        fill: #000;
      }
      #viewport-border {
        stroke: #444;
        pointer-events: none;
        fill: none;
      }
      #viewport-back {
        visibility: hidden;
        pointer-events: all;
      }
      #viewport {
        cursor: none;
      }
      #cursor-layer {
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <svg id='screen-container'>
      <rect id='screen-back'></rect>
      <g id='viewport'>
        <rect id='viewport-back'></rect>
        <svg
           xmlns:dc="http://purl.org/dc/elements/1.1/"
           xmlns:cc="http://creativecommons.org/ns#"
           xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
           xmlns:svg="http://www.w3.org/2000/svg"
           xmlns="http://www.w3.org/2000/svg"
           version="1.1"
           id="scene-raw"
           viewBox="0 0 320 200"
           height="200"
           width="320">
          <defs
             id="defs4" />
          <metadata
             id="metadata7">
            <rdf:RDF>
              <cc:Work
                 rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type
                   rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
              </cc:Work>
            </rdf:RDF>
          </metadata>
          <g
             transform="translate(0,-812.36214)"
             id="layer1">
            <path
               id="path4000"
               d="M 42.204874,900.75113 C 39.174086,911.35624 36.974189,922.4867 42.580847,932.79303 47.917399,944.72528 61.760327,950.24798 74.683606,949.61356 115.15334,949.88191 169.17735,923.45617 158.81289,882.61726 156.8602,871.35113 149.97773,860.22834 140.20767,853.50442 132.01636,848.50676 121.7253,846.82015 112.15808,846.88196 81.625972,855.05632 46.624699,867.97749 42.204874,900.75113 Z"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#ff0000;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
            <path
               id="path4821"
               d="M 83.392857,861.46928 C 85.234324,857.19819 87.079118,852.44279 91.111201,849.77684 94.211286,848.68967 97.124837,851.00225 100.22306,850.93859 105.01718,851.4928 109.67122,853.69806 114.08188,855.72289 115.62512,856.25746 116.93435,858.31592 114.29589,857.71043 111.43881,857.28873 108.52005,857.59401 105.63476,857.54488 100.86389,857.59989 96.052008,857.59872 91.348102,856.69705 87.657933,857.82956 86.122582,861.72067 83.830788,864.44401 83.660018,864.5545 83.275776,864.91922 83.214286,864.505"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#00ff00;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
            <path
               id="path4819"
               d="M 75.178572,866.46928 C 69.638517,866.29408 64.416415,868.44322 59.116834,869.71607 56.746949,870.56736 55.83811,873.17243 55.46677,875.4432 55.077819,877.68276 54.752855,879.98786 53.599451,881.9898 51.770599,886.35966 53.347133,891.19521 52.234084,895.69444 53.766817,895.80288 54.082593,893.26022 54.7489,892.12306 55.35564,890.50706 55.865264,888.86185 56.661742,887.32759 58.455429,882.96932 58.097355,877.93425 60.539383,873.81421 64.545128,872.21063 68.991502,871.99425 72.884904,870.07131 75.765626,869.21531 78.718587,868.51861 81.428572,867.18357"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#00ff00;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
            <path
               id="path4838"
               d="M 80.357143,867.18356 C 80.087287,871.22978 77.948102,875.29627 77.140907,879.24491 77.026257,882.2485 78.984963,884.72205 80.434542,887.17409 81.405506,888.86917 83.603905,890.17659 84.42926,891.95899 85.277763,893.5024 86.208485,895.07847 87.651223,896.14215 87.957933,892.36524 88.046971,888.82542 87.922937,885.01571 88.088979,882.00348 88.625722,878.7405 87.102655,875.96693 85.279607,872.71042 84.188922,869.35436 82.678571,865.93356"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#00ff00;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
            <path
               id="path4006"
               d="M 85.276529,862.55929 C 81.061791,854.42119 73.715928,846.59262 66.967905,841.87163 65.686865,840.51579 64.046112,839.31866 62.097187,839.24916 59.624077,839.03217 56.592967,840.41453 56.201205,843.09696 55.948205,845.33584 57.808919,846.92683 59.296441,848.28794 70.437383,856.54648 71.820738,862.67995 76.872345,868.08532 82.509389,870.21878 86.09377,867.18924 85.276529,862.55929 Z"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#00ff00;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
            <path
               id="path4017"
               d="M 64.642857,843.255 C 64.642857,843.255 64.107143,846.64785 59.821429,846.11214"
               style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:none;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" />
          </g>
        </svg>
        <svg id='scene-final' width='320' height='200' viewBox='0 0 320 200'>
        </svg>
        <svg id='cursor-layer' width='320' height='200' viewBox='0 0 320 200'>
          <g id='cursor-group'>
            <g id='cursor' style='visibility:hidden'>
              <rect width='16' height='16' x='0.5' y='0.5' fill='#fff'></rect>
            </g>
          </g>
        </svg>
        <rect id='viewport-border' x='-0.5' y='-0.5'></rect>
      </g>
    </svg>
    <script>
      var screenBack = document.getElementById('screen-back');
      var screenEl = document.getElementById('screen-container');
      var viewportEl = document.getElementById('viewport');
      var viewportBorder = document.getElementById('viewport-border');
      var sceneRaw = document.getElementById('scene-raw');
      var sceneFinal = document.getElementById('scene-final');
      var cursorLayer = document.getElementById('cursor-layer');
      var cursor = document.getElementById('cursor');
      var cursorGroup = document.getElementById('cursor-group');
      var viewportBack = document.getElementById('viewport-back');
      var viewport = document.getElementById('viewport');
      viewport.addEventListener('mousemove', function(e) {
        var pt = cursorGroup.ownerSVGElement.createSVGPoint();
        pt.x = e.screenX;
        pt.y = e.screenY;
        var mat = cursorGroup.getScreenCTM().inverse();
        pt = pt.matrixTransform(mat);
        pt.x = Math.floor(pt.x);
        pt.y = Math.floor(pt.y);
        var transform = cursor.ownerSVGElement.createSVGTransform();
        transform.setTranslate(pt.x, pt.y);
        cursor.transform.baseVal.clear();
        cursor.transform.baseVal.appendItem(transform);
        cursor.style.visibility = 'visible';
      });
      viewport.addEventListener('mouseleave', function(e) {
        if (e.target === this) {
          cursor.style.visibility = 'hidden';
        }
      });
      var sceneWidth = 320;
      var sceneHeight = 200;
      function updateViewBox() {
        var screenRect = screenEl.getBoundingClientRect();
        var w = Math.round((screenRect.right - screenRect.left) * window.devicePixelRatio);
        var h = Math.round((screenRect.bottom - screenRect.top) * window.devicePixelRatio);
        screenEl.setAttribute('viewBox', '0 0 '+w+' '+h);
        screenBack.setAttribute('width', w);
        screenBack.setAttribute('height', h);
        var scale = 1;
        while (((scale+1)*sceneWidth) <= w && ((scale+1)*sceneHeight) <= h) scale++;
        viewportEl.setAttribute('transform', 'translate('
                                + Math.max(0, Math.floor((w-(scale * sceneWidth))/2))
                                + ','
                                + Math.max(0, Math.floor((h-(scale * sceneHeight))/2))
                               + ')');
        viewportBorder.setAttribute('width', sceneWidth * scale + 2);
        viewportBorder.setAttribute('height', sceneHeight * scale + 2);
        sceneRaw.setAttribute('width', sceneWidth * scale);
        sceneRaw.setAttribute('height', sceneHeight * scale);
        sceneFinal.setAttribute('width', sceneWidth * scale);
        sceneFinal.setAttribute('height', sceneHeight * scale);
        cursorLayer.setAttribute('width', sceneWidth * scale);
        cursorLayer.setAttribute('height', sceneHeight * scale);
        viewportBack.setAttribute('width', sceneWidth * scale);
        viewportBack.setAttribute('height', sceneHeight * scale);
      }
      window.addEventListener('resize', updateViewBox);
      updateViewBox();
      function updateScene() {
        while (sceneFinal.firstChild) sceneFinal.removeChild(sceneFinal.firstChild);
        function iterate(el, mat) {
          for (var child = el.firstElementChild; child; child = child.nextElementSibling) {
            var childMat = mat;
            if ('transform' in el) {
              var t = el.transform.baseVal;
              for (var i = 0; i < t.numberOfItems; i++) {
                childMat = childMat.multiply(t.getItem(i).matrix);
              }
            }
            switch (child.nodeName) {
              case 'g':
                iterate(child, childMat);
                break;
              case 'path':
              case 'circle':
              case 'ellipse':
              case 'rect':
              case 'line':
              case 'polyline':
              case 'polygon':
                var subPaths = SubPath.getFromElement(child, childMat);
                for (var i = 0; i < subPaths.length; i++) {
                  subPaths[i].makeMonotonic();
                  subPaths[i].normalizeEnds();
                  subPaths[i].flatten(1.5);
                }
                var outPath = SubPath.createElement(subPaths);
                var style = window.getComputedStyle(child);
                var fill = style.getPropertyValue('fill');
                var stroke = style.getPropertyValue('stroke');
                outPath.setAttribute('fill', fill);
                outPath.setAttribute('stroke', stroke);
                sceneFinal.appendChild(outPath);
                break;
            }
          }
        }
        iterate(sceneRaw, sceneRaw.createSVGMatrix());
      }
      updateScene();
      
      if (typeof screenEl.requestFullscreen !== 'function') {
        ['moz', 'webkit', 'ms'].forEach(function(prefix) {
          screenEl.requestFullscreen = screenEl.requestFullscreen
            || screenEl[prefix+'RequestFullscreen']
            || screenEl[prefix+'RequestFullScreen'];
          document.exitFullscreen = document.exitFullscreen
            || document[prefix+'ExitFullscreen']
            || document[prefix+'ExitFullScreen'];
          [prefix+'FullScreenElement', prefix+'FullscreenElement'].forEach(function(propertyName) {
            if (propertyName in document && !('fullscreenElement' in document)) {
              Object.defineProperty(document, 'fullscreenElement', {
                get: function() {
                  return this[propertyName];
                },
              });
            }
          });
        });
        screenEl.requestFullscreen = screenEl.requestFullscreen || function(){};
      }
      if (typeof screenEl.requestPointerLock !== 'function') {
        screenEl.requestPointerLock = screenEl.mozRequestPointerLock
          || screenEl.webkitRequestPointerLock
          || screenEl.msRequestPointerLock
          || function(){};
        document.exitPointerLock = document.mozExitPointerLock
          || document.webkitExitPointerLock
          || document.msExitPointerLock;
      }
      ['moz', 'webkit', 'ms'].forEach(function(prefix) {
        document.addEventListener(prefix+'fullscreenchange', function(e) {
          e.target.dispatchEvent(new Event('fullscreenchange', {bubbles:true}));
        });
      });
      
      window.addEventListener('keypress', function(e) {
        if ((e.keyCode === 10 || e.keyCode === 13) && e.altKey) {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          }
          else {
            screenEl.requestFullscreen();
          }
        }
      });
      document.addEventListener('fullscreenchange', function(e) {
        if (document.fullscreenElement) {
          screenEl.requestPointerLock();
        }
        else if (document.pointerLockElement) {
          document.exitPointerLock();
        }
      });
    </script>
      <!--
    <svg id='screen' width='640' height='400' viewBox='0 0 640 400'>
      <metadata>
        <scene xmlns='gongoozler'>
          
        </scene>
      </metadata>
      <path d='M 93.944187,321.8248 93.944187,49.083607' fill='none' stroke='black'></path>
      <path d='M 297.995,316.77405 C 298.9696,264.32735 225.23292,157.53289 322.23866,53.124217' fill='none' stroke='black'></path>
      <path d='
         M 524.26917,321.82481
         C 526.77678,249.13445 585.86293,248.21503 517.42565,188.14617
           448.98837,128.07731 525.76885,123.00622 522.24886,60.195287
      ' fill='none' stroke='black'></path>
    </svg>
    <script>
      document.createSVGElement = function createSVGElement(name) {
        return document.createElementNS("http://www.w3.org/2000/svg", name);
      };
      function between(v1, v2) {
        return v1 + (v2-v1) * (
          Math.random() + Math.random() + Math.random()
          + Math.random() + Math.random() + Math.random()
        )/6;
      }
      var screen = document.getElementById('screen');
      for (var el = screen.firstElementChild; el; el = el.nextElementSibling) {
        var pathData = el.getPathData({normalize:true});
        console.log(pathData);
      }
    </script>
      -->
  </body>
</html>
